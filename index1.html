<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>إنشاء حساب</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBcgBaXfoQazccxSYF538PmpaL5fUH-RoA",
      authDomain: "trading-4b0aa.firebaseapp.com",
      projectId: "trading-4b0aa",
      storageBucket: "trading-4b0aa.appspot.com",
      messagingSenderId: "738549332722",
      appId: "1:738549332722:web:6e407e8312dd0600842e6b",
      measurementId: "G-4MMPM6LMN4",
      databaseURL: "https://trading-4b0aa-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    window.togglePassword = (fieldId, iconId) => {
      const field = document.getElementById(fieldId);
      const icon = document.getElementById(iconId);
      
      if (field.type === 'password') {
        field.type = 'text';
        icon.textContent = 'visibility_off';
      } else {
        field.type = 'password';
        icon.textContent = 'visibility';
      }
    };

    function generateUserId() {
      const timestamp = Date.now().toString(36);
      const randomStr = Math.random().toString(36).substr(2, 5);
      return `user_${timestamp}_${randomStr}`;
    }

    window.submitForm = async () => {
      const countryCode = document.getElementById('countryCode').value;
      const phoneNumber = document.getElementById('phoneNumber').value.trim();
      const phone = countryCode + phoneNumber;
      const password = document.getElementById('password').value.trim();
      const confirm = document.getElementById('confirm').value.trim();
      const invite = document.getElementById('invite').value.trim();
      const loader = document.getElementById("loaderBox");

      const countryPatterns = {
        "+967": /^7\d{8}$/,
        "+966": /^5\d{8}$/,
        "+20":  /^1\d{9}$/,
        "+971": /^5\d{8}$/,
        "+213": /^(5|6|7)\d{8}$/,
        "+973": /^3\d{7}$/,
        "+269": /^3\d{6}$/,
        "+965": /^(5|6|9)\d{7}$/,
        "+961": /^(3|7)\d{7}$/,
        "+218": /^9\d{8}$/,
        "+222": /^2\d{7}$/,
        "+212": /^6\d{8}$/,
        "+968": /^9\d{7}$/,
        "+970": /^5\d{8}$/,
        "+974": /^(3|5)\d{7}$/,
        "+249": /^9\d{8}$/,
        "+963": /^9\d{8}$/,
        "+216": /^(2|5|9)\d{7}$/,
        "+964": /^7\d{9}$/,
        "+962": /^7\d{8}$/,
        "+252": /^(6|7)\d{7}$/
      };

      if (!countryPatterns[countryCode].test(phoneNumber)) {
        const errorMessages = {
          "+967": "رقم اليمن يجب أن يبدأ بـ 7 ويحتوي على 9 أرقام",
          "+966": "رقم السعودية يجب أن يبدأ بـ 5 ويحتوي على 9 أرقام",
          "+20":  "رقم مصر يجب أن يبدأ بـ 1 ويحتوي على 10 أرقام",
          "+971": "رقم الإمارات يجب أن يبدأ بـ 5 ويحتوي على 9 أرقام",
          "+213": "رقم الجزائر يجب أن يبدأ بـ 5 أو 6 أو 7 ويحتوي على 9 أرقام",
          "+973": "رقم البحرين يجب أن يبدأ بـ 3 ويحتوي على 8 أرقام",
          "+269": "رقم جزر القمر يجب أن يبدأ بـ 3 ويحتوي على 7 أرقام",
          "+965": "رقم الكويت يجب أن يبدأ بـ 5 أو 6 أو 9 ويحتوي على 8 أرقام",
          "+961": "رقم لبنان يجب أن يبدأ بـ 3 أو 7 ويحتوي على 8 أرقام",
          "+218": "رقم ليبيا يجب أن يبدأ بـ 9 ويحتوي على 9 أرقام",
          "+222": "رقم موريتانيا يجب أن يبدأ بـ 2 ويحتوي على 8 أرقام",
          "+212": "رقم المغرب يجب أن يبدأ بـ 6 ويحتوي على 9 أرقام",
          "+968": "رقم عمان يجب أن يبدأ بـ 9 ويحتوي على 8 أرقام",
          "+970": "رقم فلسطين يجب أن يبدأ بـ 5 ويحتوي على 9 أرقام",
          "+974": "رقم قطر يجب أن يبدأ بـ 3 أو 5 ويحتوي على 8 أرقام",
          "+249": "رقم السودان يجب أن يبدأ بـ 9 ويحتوي على 9 أرقام",
          "+963": "رقم سوريا يجب أن يبدأ بـ 9 ويحتوي على 9 أرقام",
          "+216": "رقم تونس يجب أن يبدأ بـ 2 أو 5 أو 9 ويحتوي على 8 أرقام",
          "+964": "رقم العراق يجب أن يبدأ بـ 7 ويحتوي على 10 أرقام",
          "+962": "رقم الأردن يجب أن يبدأ بـ 7 ويحتوي على 9 أرقام",
          "+252": "رقم الصومال يجب أن يبدأ بـ 6 أو 7 ويحتوي على 8 أرقام"
        };
        Swal.fire({
          icon: 'error',
          title: 'خطأ',
          text: errorMessages[countryCode],
          confirmButtonText: 'حسناً',
          confirmButtonColor: '#3085d6',
        });
        return;
      }

      if (!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{7,}$/.test(password)) {
        Swal.fire({
          icon: 'error',
          title: 'خطأ',
          text: 'كلمة المرور يجب أن تحتوي على 7 أحرف على الأقل وأرقام وأحرف إنجليزية.',
          confirmButtonText: 'حسناً',
          confirmButtonColor: '#3085d6',
        });
        return;
      }
      if (password !== confirm) {
        Swal.fire({
          icon: 'error',
          title: 'خطأ',
          text: 'كلمتا المرور غير متطابقتين.',
          confirmButtonText: 'حسناً',
          confirmButtonColor: '#3085d6',
        });
        return;
      }

      loader.style.display = 'flex';

      try {
        // التحقق من عدم وجود رقم الهاتف مسجل مسبقاً
        const usersSnapshot = await get(ref(db, 'users/'));
        const users = usersSnapshot.val() || {};
        
        let phoneExists = false;
        for (const userId in users) {
          if (users[userId].phone === phone) {
            phoneExists = true;
            break;
          }
        }

        if (phoneExists) {
          loader.style.display = 'none';
          Swal.fire({
            icon: 'error',
            title: 'خطأ',
            text: 'رقم الهاتف مسجل مسبقاً',
            confirmButtonText: 'حسناً',
            confirmButtonColor: '#3085d6',
          });
          return;
        }

        // إنشاء ID فريد للمستخدم
        const userId = generateUserId();
        
        // حفظ بيانات المستخدم في قاعدة البيانات
        await set(ref(db, 'users/' + userId), {
          userId: userId,
          phone,
          password,
          invite,
          balance: 0,
          profit: 0,
          deposit: 0,
          dailyProfit: 0,
          yesterdayProfit: 0,
          monthlyProfit: 0,
          totalProfit: 0,
          createdAt: Date.now()
        });

        // إنشاء سجل الدعوة إذا كان هناك رمز دعوة
        if (invite) {
          // البحث عن المستخدم الذي قام بالدعوة
          const referralsRef = ref(db, 'referrals/');
          const referralsSnapshot = await get(referralsRef);
          const referrals = referralsSnapshot.val() || {};
          
          let referrerId = null;
          for (const id in referrals) {
            if (referrals[id].referralCode === invite) {
              referrerId = id;
              break;
            }
          }

          if (referrerId) {
            // تحديث بيانات المدعو
            const newReferralId = `ref_${Date.now()}`;
            await set(ref(db, `referrals/${referrerId}/referrals/${newReferralId}`), {
              name: phone,
              status: 'pending',
              earnings: 0,
              timestamp: Date.now()
            });

            // تحديث إحصائيات المدعو
            await set(ref(db, `referrals/${referrerId}/invitedCount`), 
              (referrals[referrerId].invitedCount || 0) + 1);
          }
        }

        // إنشاء سجل الدعوة الخاص بالمستخدم الجديد
        const referralCode = 'ARTIKAR-' + userId.substring(5, 13).toUpperCase();
        await set(ref(db, `referrals/${userId}`), {
          referralCode: referralCode,
          totalEarnings: 0,
          invitedCount: 0,
          registeredCount: 0,
          depositedCount: 0,
          referrals: {},
          createdAt: Date.now()
        });

        setTimeout(() => {
          loader.innerHTML = '<div class="box">✅ تم إنشاء الحساب بنجاح</div>';
          setTimeout(() => {
            localStorage.setItem('loggedInUser', JSON.stringify({
              phone,
              countryCode,
              password,
              userId
            }));
            window.location.href = "index.html";
          }, 1500);
        }, 1500);
      } catch (error) {
        loader.style.display = 'none';
        Swal.fire({
          icon: 'error',
          title: 'خطأ',
          text: 'حدث خطأ: ' + error.message,
          confirmButtonText: 'حسناً',
          confirmButtonColor: '#3085d6',
        });
      }
    };
  </script>
  <style>
    * { box-sizing: border-box; font-family: sans-serif; }
    body { margin: 0; background: #f3f3f3; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
    .card { background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 20px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    .card img { width: 110px; margin: 20px auto; }
    .card h2 { margin-bottom: 20px; }
    input, select { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #ccc; font-size: 16px; }
    .phone-container { display: flex; gap: 10px; }
    .country-code { width: 120px; }
    .phone-number { flex: 1; }
    
    .password-field-container {
      position: relative;
      margin-bottom: 15px;
    }
    .password-field-container input {
      width: 100%;
      padding-right: 40px;
    }
    .toggle-password {
      position: absolute;
      top: 50%;
      left: 10px;
      transform: translateY(-50%);
      cursor: pointer;
      color: #666;
    }
    
    button { width: 100%; padding: 12px; border: none; border-radius: 10px; background: gray; color: white; font-size: 18px; cursor: pointer; }
    button:hover { background: #333; }
    .link { font-size: 12px; color: #007BFF; cursor: pointer; }
    #loaderBox {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .box {
      background: white;
      padding: 20px 40px;
      border-radius: 10px;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #444;
    }
    .box::after {
      content: '';
      width: 20px; height: 20px;
      border: 3px solid #ccc;
      border-top-color: #3f3f3f;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>


 <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#6e48aa">

<body>
  <div class="card">
    <img src="https1.png" alt="logo" />
    <h2>إنشاء حساب</h2>
    
    <div class="phone-container">
      <select id="countryCode" class="country-code">
        <option value="+967">🇾🇪 اليمن +967</option>
        <option value="+966">🇸🇦 السعودية +966</option>
        <option value="+20">🇪🇬 مصر +20</option>
        <option value="+971">🇦🇪 الإمارات +971</option>
        <option value="+213">🇩🇿 الجزائر +213</option>
        <option value="+973">🇧🇭 البحرين +973</option>
        <option value="+269">🇰🇲 جزر القمر +269</option>
        <option value="+965">🇰🇼 الكويت +965</option>
        <option value="+961">🇱🇧 لبنان +961</option>
        <option value="+218">🇱🇾 ليبيا +218</option>
        <option value="+222">🇲🇷 موريتانيا +222</option>
        <option value="+212">🇲🇦 المغرب +212</option>
        <option value="+968">🇴🇲 عمان +968</option>
        <option value="+970">🇵🇸 فلسطين +970</option>
        <option value="+974">🇶🇦 قطر +974</option>
        <option value="+249">🇸🇩 السودان +249</option>
        <option value="+963">🇸🇾 سوريا +963</option>
        <option value="+216">🇹🇳 تونس +216</option>
        <option value="+964">🇮🇶 العراق +964</option>
        <option value="+962">🇯🇴 الأردن +962</option>
        <option value="+252">🇸🇴 الصومال +252</option>
      </select>
      <input type="tel" id="phoneNumber" class="phone-number" placeholder="رقم الهاتف">
    </div>
    
    <div class="password-field-container">
      <input type="password" id="password" placeholder="كلمة المرور">
      <i class="material-icons toggle-password" id="togglePassword1" onclick="togglePassword('password', 'togglePassword1')">visibility</i>
    </div>
    
    <div class="password-field-container">
      <input type="password" id="confirm" placeholder="إعادة كلمة المرور">
      <i class="material-icons toggle-password" id="togglePassword2" onclick="togglePassword('confirm', 'togglePassword2')">visibility</i>
    </div>
    
    <input type="text" id="invite" placeholder="رمز الدعوة اختياري">
    <button onclick="submitForm()">إنشاء حساب</button>
    <p class="link" onclick="window.location.href='index.html'">تسجيل الدخول</p>
    <p style="font-size:12px;margin-top:10px;">© Artiker جميع الحقوق محفوظة</p>
  </div>
  <div id="loaderBox">
    <div class="box">جاري إنشاء الحساب...</div>
  </div>
</body>
</html>