<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تسجيل الدخول</title>

  <!-- 1) manifest (جديد) -->
  <link rel="manifest" href=".index.json">
  <meta name="theme-color" content="#6e8efb">

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    * { box-sizing: border-box; font-family: sans-serif; }
    body { margin: 0; background: #f3f3f3; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }

    /* زر التثبيت (جديد) */
    #installBtn {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 9999;
      display: none;            /* يظهر تلقائياً لما يكون التثبيت متاح */
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg,#6e8efb,#9d50bb);
      color: #fff;
      border: 0;
      border-radius: 999px;
      padding: 10px 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,.18);
      cursor: pointer;
      font-weight: 700;
    }
    #installBtn .material-icons { font-size: 20px; }

    #splashScreen {  
      position: fixed;  
      top: 0; left: 0;  
      width: 100%; height: 100%;  
      background: white;  
      display: flex;  
      justify-content: center;  
      align-items: center;  
      z-index: 1000;  
    }  
    #splashScreen img {  
      max-width: 110%;  
      max-height: 110%;  
    }  
    
    #loginForm {  
      background: white;   
      width: 90%;   
      max-width: 400px;   
      border-radius: 20px;   
      padding: 20px;   
      text-align: center;   
      box-shadow: 0 0 20px rgba(0,0,0,0.1);  
      display: none;  
    }  
    #loginForm img { width: 110px; margin: 20px auto; }  
    #loginForm h2 { margin-bottom: 20px; }  
    .phone-container { display: flex; gap: 10px; margin-bottom: 15px; }  
    .country-code { width: 120px; padding: 12px; border-radius: 10px; border: 1px solid #ccc; }  
    .phone-number { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #ccc; }  
    .password-container { position: relative; margin-bottom: 15px; }  
    #password { width: 100%; padding: 12px 40px 12px 12px; border-radius: 10px; border: 1px solid #ccc; font-size: 16px; }  
    .toggle-password { position: absolute; top: 50%; left: 10px; transform: translateY(-50%); cursor: pointer; color: #666; user-select: none; }  
    #loginForm button { width: 100%; padding: 12px; border: none; border-radius: 10px; background: gray; color: white; font-size: 18px; cursor: pointer; }  
    #loginForm button:hover { background: #333; }  
    .link { font-size: 12px; color: #007BFF; cursor: pointer; margin: 10px 0; }  
    #loaderBox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 999; }  
    .box { background: white; padding: 20px 40px; border-radius: 10px; font-size: 20px; display: flex; align-items: center; gap: 10px; color: #444; }  
    #loaderBox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 999; }  
    .box { padding: 10px 20px; font-size: 14px; }  
    .box::after { width: 12px; height: 12px; border-width: 2px; }   
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>

  <!-- تسجيل service worker (جديد) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('index.js').catch(()=>{});
      });
    }
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBcgBaXfoQazccxSYF538PmpaL5fUH-RoA",
      authDomain: "trading-4b0aa.firebaseapp.com",
      projectId: "trading-4b0aa",
      storageBucket: "trading-4b0aa.appspot.com",
      messagingSenderId: "738549332722",
      appId: "1:738549332722:web:6e407e8312dd0600842e6b",
      measurementId: "G-4MMPM6LMN4",
      databaseURL: "https://trading-4b0aa-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    /* ===== زر التثبيت – من غير ما نغيّر أي منطق عندك ===== */
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const btn = document.getElementById('installBtn');
      if (btn) btn.style.display = 'flex';
    });

    window.installPWA = async function () {
      const btn = document.getElementById('installBtn');
      if (!deferredPrompt) {
        Swal.fire({
          icon: 'info',
          title: 'معلومة',
          text: 'التثبيت غير متاح حالياً. افتح الموقع عبر Chrome على Android أو Chrome/Edge على الكمبيوتر.',
          confirmButtonText: 'حسناً'
        });
        return;
      }
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      deferredPrompt = null;
      if (btn) btn.style.display = 'none';
      // اختياري: عرض نتيجة المستخدم
      // console.log('Install outcome:', choice.outcome);
    };
    /* ================================================ */

    window.togglePassword = function() {
      const passwordField = document.getElementById('password');
      const toggleIcon = document.getElementById('togglePasswordIcon');
      if (passwordField.type === 'password') {
        passwordField.type = 'text';
        toggleIcon.textContent = 'visibility_off';
      } else {
        passwordField.type = 'password';
        toggleIcon.textContent = 'visibility';
      }
    };

    document.addEventListener('DOMContentLoaded', function() {
      if (!sessionStorage.getItem('splashShown')) {
        sessionStorage.setItem('splashShown', 'true');
        setTimeout(function() {
          document.getElementById('splashScreen').style.display = 'none';
          document.getElementById('loginForm').style.display = 'block';
        }, 3000);
      } else {
        document.getElementById('splashScreen').style.display = 'none';
        document.getElementById('loginForm').style.display = 'block';
      }
      
      const savedUser = localStorage.getItem('loggedInUser');
      if (savedUser) {
        const user = JSON.parse(savedUser);
        document.getElementById('phoneNumber').value = user.phone.replace(user.countryCode, '');
        document.getElementById('countryCode').value = user.countryCode;
        document.getElementById('password').value = user.password;
      }
    });

    window.loginUser = function() {
      const countryCode = document.getElementById('countryCode').value;
      const phoneNumber = document.getElementById('phoneNumber').value.trim();
      const phone = countryCode + phoneNumber;
      const password = document.getElementById('password').value.trim();
      const loader = document.getElementById("loaderBox");

      const countryPatterns = {
        "+967": /^7\d{8}$/,
        "+966": /^5\d{8}$/,
        "+20":  /^1\d{9}$/,
        "+971": /^5\d{8}$/,
        "+213": /^(5|6|7)\d{8}$/,
        "+973": /^3\d{7}$/,
        "+269": /^3\d{6}$/,
        "+965": /^(5|6|9)\d{7}$/,
        "+961": /^(3|7)\d{7}$/,
        "+218": /^9\d{8}$/,
        "+222": /^2\d{7}$/,
        "+212": /^6\d{8}$/,
        "+968": /^9\d{7}$/,
        "+970": /^5\d{8}$/,
        "+974": /^(3|5)\d{7}$/,
        "+249": /^9\d{8}$/,
        "+963": /^9\d{8}$/,
        "+216": /^(2|5|9)\d{7}$/,
        "+964": /^7\d{9}$/,
        "+962": /^7\d{8}$/,
        "+252": /^(6|7)\d{7}$/
      };

      if (!countryPatterns[countryCode].test(phoneNumber)) {
        const errorMessages = {
          "+967": "رقم اليمن يجب أن يبدأ بـ 7 ويحتوي على 9 أرقام",
          "+966": "رقم السعودية يجب أن يبدأ بـ 5 ويحتوي على 9 أرقام",
          "+20":  "رقم مصر يجب أن يبدأ بـ 1 ويحتوي على 10 أرقام",
          "+971": "رقم الإمارات يجب أن يبدأ بـ 5 ويحتوي على 9 أرقام",
          "+213": "رقم الجزائر يجب أن يبدأ بـ 5 أو 6 أو 7 ويحتوي على 9 أرقام",
          "+973": "رقم البحرين يجب أن يبدأ بـ 3 ويحتوي على 8 أرقام",
          "+269": "رقم جزر القمر يجب أن يبدأ بـ 3 ويحتوي على 7 أرقام",
          "+965": "رقم الكويت يجب أن يبدأ بـ 5 أو 6 أو 9 ويحتوي على 8 أرقام",
          "+961": "رقم لبنان يجب أن يبدأ بـ 3 أو 7 ويحتوي على 8 أرقام",
          "+218": "رقم ليبيا يجب أن يبدأ بـ 9 ويحتوي على 9 أرقام",
          "+222": "رقم موريتانيا يجب أن يبدأ بـ 2 ويحتوي على 8 أرقام",
          "+212": "رقم المغرب يجب أن يبدأ بـ 6 ويحتوي على 9 أرقام",
          "+968": "رقم عمان يجب أن يبدأ بـ 9 ويحتوي على 8 أرقام",
          "+970": "رقم فلسطين يجب أن يبدأ بـ 5 ويحتوي على 9 أرقام",
          "+974": "رقم قطر يجب أن يبدأ بـ 3 أو 5 ويحتوي على 8 أرقام",
          "+249": "رقم السودان يجب أن يبدأ بـ 9 ويحتوي على 9 أرقام",
          "+963": "رقم سوريا يجب أن يبدأ بـ 9 ويحتوي على 9 أرقام",
          "+216": "رقم تونس يجب أن يبدأ بـ 2 أو 5 أو 9 ويحتوي على 8 أرقام",
          "+964": "رقم العراق يجب أن يبدأ بـ 7 ويحتوي على 10 أرقام",
          "+962": "رقم الأردن يجب أن يبدأ بـ 7 ويحتوي على 9 أرقام",
          "+252": "رقم الصومال يجب أن يبدأ بـ 6 أو 7 ويحتوي على 8 أرقام"
        };
        Swal.fire({ icon:'error', title:'خطأ', text:errorMessages[countryCode], confirmButtonText:'حسناً', confirmButtonColor:'#3085d6' });
        return;
      }

      if (!password) {
        Swal.fire({ icon:'error', title:'خطأ', text:'يجب إدخال كلمة المرور', confirmButtonText:'حسناً', confirmButtonColor:'#3085d6' });
        return;
      }

      loader.style.display = 'flex';

      get(ref(db, 'users/')).then((snapshot) => {
        const users = snapshot.val();
        let userFound = false;
        let userId = '';
        
        for (const id in users) {
          if (users[id].phone === phone && users[id].password === password) {
            userFound = true;
            userId = id;
            break;
          }
        }

        setTimeout(() => {
          if (userFound) {
            const referralRef = ref(db, `referrals/${userId}`);
            get(referralRef).then((refSnapshot) => {
              if (!refSnapshot.exists()) {
                const referralCode = 'ARTIKAR-' + userId.substring(0, 8).toUpperCase();
                set(referralRef, {
                  referralCode,
                  totalEarnings: 0,
                  invitedCount: 0,
                  registeredCount: 0,
                  depositedCount: 0,
                  referrals: {},
                  createdAt: serverTimestamp()
                });
              }
              completeLogin(phone, countryCode, password, userId);
            });
          } else {
            loader.style.display = 'none';
            Swal.fire({ icon:'error', title:'خطأ', text:'رقم الهاتف أو كلمة المرور غير صحيحة', confirmButtonText:'حسناً', confirmButtonColor:'#3085d6' });
          }
        }, 1500);
      }).catch((error) => {
        loader.style.display = 'none';
        Swal.fire({ icon:'error', title:'خطأ', text:'حدث خطأ: ' + error.message, confirmButtonText:'حسناً', confirmButtonColor:'#3085d6' });
      });
    };

    function completeLogin(phone, countryCode, password, userId) {
      localStorage.setItem('loggedInUser', JSON.stringify({ phone, countryCode, password, userId }));
      document.getElementById("loaderBox").innerHTML = '<div class="box">✅ تم تسجيل الدخول بنجاح</div>';
      setTimeout(() => window.location.href = "index5.html", 1500);
    }
  </script>
  
 <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#6e48aa">
  
</head>



<body>
  <!-- زر تحميل/تثبيت التطبيق (جديد) -->
 <button id="installButton" style="display: none;">⚡ اضف التطبيق إلى شاشتك</button>

  <div id="splashScreen">  
    <img src="https2.png" alt="شعار التطبيق" />  
  </div>
  
  <div id="loginForm">  
    <img src="https1.png" alt="شعار" />  
    <h2>تسجيل الدخول</h2>
    
    <div class="phone-container">  
      <select id="countryCode" class="country-code">  
        <option value="+967">🇾🇪 اليمن +967</option>  
        <option value="+966">🇸🇦 السعودية +966</option>  
        <option value="+20">🇪🇬 مصر +20</option>  
        <option value="+971">🇦🇪 الإمارات +971</option>  
        <option value="+213">🇩🇿 الجزائر +213</option>  
        <option value="+973">🇧🇭 البحرين +973</option>  
        <option value="+269">🇰🇲 جزر القمر +269</option>  
        <option value="+965">🇰🇼 الكويت +965</option>  
        <option value="+961">🇱🇧 لبنان +961</option>  
        <option value="+218">🇱🇾 ليبيا +218</option>  
        <option value="+222">🇲🇷 موريتانيا +222</option>  
        <option value="+212">🇲🇦 المغرب +212</option>  
        <option value="+968">🇴🇲 عمان +968</option>  
        <option value="+970">🇵🇸 فلسطين +970</option>  
        <option value="+974">🇶🇦 قطر +974</option>  
        <option value="+249">🇸🇩 السودان +249</option>  
        <option value="+963">🇸🇾 سوريا +963</option>  
        <option value="+216">🇹🇳 تونس +216</option>  
        <option value="+964">🇮🇶 العراق +964</option>  
        <option value="+962">🇯🇴 الأردن +962</option>  
        <option value="+252">🇸🇴 الصومال +252</option>  
      </select>  
      <input type="tel" id="phoneNumber" class="phone-number" placeholder="رقم الهاتف">  
    </div>  
    
    <div class="password-container">  
      <input type="password" id="password" placeholder="كلمة المرور">  
      <span class="toggle-password" onclick="togglePassword()">  
        <i class="material-icons" id="togglePasswordIcon">visibility</i>  
      </span>  
    </div>  
    
    <p class="link" onclick="window.location.href='index1.html'">انشاء حساب</p>  
    <p class="link" onclick="window.location.href='index4.html'">هل نسيت كلمة المرور؟</p>  
    
    <button onclick="loginUser()">دخول</button>  
    <p style="font-size:12px;margin-top:10px;">© Artiker جميع الحقوق محفوظة</p>
  </div>
  
  <div id="loaderBox">  
    <div class="box">جاري التحقق...</div>  
  </div>
  
  
<link rel="manifest" href="manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(console.error);
  }
</script>
  
</body>


<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(reg => console.log("✔ Service Worker registered"))
      .catch(err => console.error("❌ Service Worker failed:", err));
  }
</script>

</html>